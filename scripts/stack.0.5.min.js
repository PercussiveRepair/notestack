var $jb=jQuery.noConflict();
function reflowCards(){$jb(".current").length!=1&&($jb(".selected").length!=1?$jb(".listnote:first").addClass("selected"):$jb("#"+$jb(".selected").data().key).addClass("current"));$jb(".prev2").removeClass("prev2");$jb(".prev1").removeClass("prev1");$jb(".next1").removeClass("next1");$jb(".next2").removeClass("next2");$jb(".current").prev(".note").prev(".note").addClass("prev2");$jb(".current").prev(".note").addClass("prev1");$jb(".current").next(".note").addClass("next1");$jb(".current").next(".note").next(".note").addClass("next2")}
function refreshCards(){console.log("refreshing cards");$jb(".selected").length!=1&&$jb(".listnote:first").addClass("selected");$jb(".note").remove();$jb(".listnote").each(function(){$jb("#note-template").clone().attr("id",$jb(this).data().key).addClass("note").appendTo(".window").children(".textarea").children("textarea").val($jb(this).data().content)});$jb("#"+$jb(".selected").data().key).addClass("current");refreshNoteBinds(".note textarea");reflowCards()}
function sortNotes(){console.log("sorting notes");$jb(".listnote").sortElements(function(a,b){if($jb(a).hasClass("pinned")){if(!$jb(b).hasClass("pinned"))return-1}else if($jb(b).hasClass("pinned")&&!$jb(a).hasClass("pinned"))return 1;return parseFloat($jb(a).data("modifydate"))<parseFloat($jb(b).data("modifydate"))?1:-1});return"sorted"}
function getNote(a){return $jb.Deferred(function(b){console.log("getting "+a);$jb.ajax("/sn.php",{type:"POST",data:{action:"note",email:email,token:token,notekey:a},success:function(a){console.log("inside get success");note=$jb.parseJSON(a);localStorage.setItem(note.key,a);$jb.when(localToDOM(note.key)).done(function(){console.log("local to dom resolved");b.resolve()})},error:function(b){console.log("error getting note "+a+" error:"+b)}});return!1}).promise()}
function sendNote(a){var b=$jb.Deferred();$jb.ajax("/sn.php",{type:"POST",data:{action:"sendnote",email:email,token:token,notekey:a.key,notebody:JSON.stringify(a)},success:function(c){console.log("note updated");note=$jb.parseJSON(c);if(!("content"in note))note.content=a.content;localStorage.setItem(note.key,JSON.stringify(note));localToDOM(note.key);sortNotes();refreshCards();b.resolve()},error:function(a){console.log("error getting note "+notekey+" error:"+a)}});return b.promise()}
function updateAllNotes(){return $jb.Deferred(function(a){console.log("iterating through index, showing local, getting if needed");index=$jb.parseJSON(localStorage.index);$jb(".status").text("Downloading "+index.count+" notes");$jb(".status-div").addClass("loading");var b,c=$jb.Deferred();getchain=c;for(b=0;b<=index.data.length-1;b++)localStorage.getItem(index.data[b].key)?(localNote=$jb.parseJSON(localStorage.getItem(index.data[b].key)),localNote.syncnum<index.data[b].syncnum?getchain=getchain.pipe(getNote(localNote.key)):
localNote.syncnum>index.data[b].syncnum?sendNote(localNote):localToDOM(localNote.key)):getchain=getchain.pipe(getNote(index.data[b].key)),b==index.data.length-1&&(console.log("on last note, changing status and starting sort"),indexDate=stackTime(localStorage.indexDate),$jb(".status").html('synced <abbr class="timeago" title="'+indexDate+'"></abbr>'),bindTimeago(),$jb(".status-div").removeClass("loading"));c.resolve();getchain.done(function(){console.log("all gets resolved");a.resolve()})}).promise()}
function syncIndex(a){return $jb.Deferred(function(b){$jb.ajax("/sn.php",{type:"POST",data:a,success:function(c){newIndex=$jb.parseJSON(c);console.log("recieved new index with "+newIndex.count+" new notes");if(localStorage.index){existingIndex=$jb.parseJSON(localStorage.index);for(i=0;i<=newIndex.data.length-1;i++){for(j=0;j<=existingIndex.data.length-1;j++)if(existingIndex.data[j].key==newIndex.data[i].key){existingIndex.data.splice(j,1);break}existingIndex.data.unshift(newIndex.data[i])}existingIndex.count=
existingIndex.data.length}else existingIndex=newIndex;localStorage.setItem("index",JSON.stringify(existingIndex));localStorage.setItem("indexDate",(new Date).getTime()/1E3);newIndex.mark?(console.log("new index had mark, getting again"),a.mark=newIndex.mark,syncIndex(a)):(console.log("about to enter updateAllNotes when"),$jb.when(updateAllNotes()).done(function(){console.log("syncIndex resolved");b.resolve()}))},error:function(a){console.log("error updating index "+a);b.failure()}})}).promise()}
function simplenoteSync(){return $jb.Deferred(function(a){$jb(".status").text("Syncing with Simplenote");$jb(".status-div").addClass("loading");console.log("syncing with simplenote");localStorage.tokenDate?parseFloat((new Date).getTime()/1E3)-parseFloat(localStorage.tokenDate)>72E3?window.location="/":(console.log("updating index"),$jb(".status").text("Syncing with Simplenote"),$jb(".status-div").addClass("loading"),since=localStorage.indexDate?localStorage.indexDate:"",email=localStorage.email,token=
localStorage.token,console.log("about to enter syncIndex when"),$jb.when(syncIndex({action:"index",email:email,token:token,since:since,length:100})).done(function(){console.log("simplenoteSync resolved");a.resolve()})):(console.log("dont have local index, sending back to login"),window.location="/")}).promise()}
function updateListnote(a){thisnote=$jb("#list-"+a);thisnote.removeClass("pinned");thisnote.data().systemtags.indexOf("pinned")>-1&&thisnote.addClass("pinned");titlebreak=thisnote.data().content.indexOf("\n");titlebreak<0?(thisnote.children(".title").text(thisnote.data().content.substring(0,100)),thisnote.children(".preview").text("")):(thisnote.children(".title").text(thisnote.data().content.substring(0,titlebreak)),thisnote.children(".preview").text(thisnote.data().content.substr(titlebreak,100)))}
function localToDOM(a){return $jb.Deferred(function(b){console.log("local to DOM "+a);note=$jb.parseJSON(localStorage.getItem(a));note.deleted!=1&&($jb("#list-"+note.key).length>0?$jb("#list-"+note.key).removeData().data(note):$jb("#listnote-template").clone().attr("id","list-"+note.key).addClass("listnote").appendTo(".list").data(note),updateListnote(note.key),sortNotes(),refreshCards(),b.resolve())}).promise()}
function allLocalToDOM(){$jb(".status").text("Loading notes from local storage");$jb(".status-div").addClass("loading");if(localStorage.index){index=$jb.parseJSON(localStorage.index);console.log("loading "+index.data.length+" local notes");for(i=0;i<=index.data.length-1;i++)localStorage.getItem(index.data[i].key)!=null&&localToDOM(index.data[i].key)}console.log("local notes loaded")}
$jb(function(){localStorage.email?($jb(".username").text(localStorage.email),localStorage.index&&(allLocalToDOM(),$jb(".listnote").length>0&&(sortNotes(),refreshCards())),console.log("about to enter simplenoteSync when"),$jb.when(simplenoteSync()).done(function(){console.log("done with all simplenoteSync promises");sortNotes();refreshCards()})):window.location="/"});
$jb(function(){$jb(".listnote").live("click",function(){$jb(".selected").removeClass("selected");$jb(this).addClass("selected");$jb(".current").removeClass("current");$jb("#"+$jb(this).attr("id").split("list-").pop()).addClass("current");reflowCards()})});$jb(function(){$jb(".note").live("click",function(){$jb(".current").removeClass("current");$jb(this).addClass("current");$jb(".selected").removeClass("selected");$jb("#list-"+$jb(this).attr("id")).addClass("selected");reflowCards()})});
$jb(function(){$jb(".settings_icon").click(function(){$jb(".settings").toggleClass("show")});$jb(".username").click(function(){$jb(".settings").toggleClass("show");$jb(".settings_pane").removeClass("show");$jb(".settings_pane.data").addClass("show")})});$jb(function(){$jb(".settings .tabs a").click(function(){$jb(".settings_pane").removeClass("show");$jb(".settings_pane."+$jb(this).text().replace(" ","_")).addClass("show");return!1})});
$jb(function(){if(localStorage.theme)themename=localStorage.theme,$jb(".fullwindow").removeClass().addClass("fullwindow").addClass(themename);$jb(".appearance .item.theme").click(function(){themename=$jb(this).attr("id");$jb(".fullwindow").removeClass("android","theme1").addClass(themename);localStorage.theme=themename});$jb(".appearance .item.font").click(function(){fontname=$jb(this).attr("id");$jb(".fullwindow").removeClass("font-mono").removeClass("font-sans").removeClass("font-serif").addClass(fontname);
localStorage.font=fontname})});
$jb(function(){$jb(document).bind("keydown","esc",function(){$jb(".settings").removeClass("show")});$jb(document).bind("keydown","j",function(){nextNote()});$jb(document).bind("keydown","right",function(){nextNote()});$jb(document).bind("keydown","down",function(){nextNote()});$jb(document).bind("keydown","k",function(){prevNote()});$jb(document).bind("keydown","left",function(){prevNote()});$jb(document).bind("keydown","up",function(){prevNote()});$jb(document).bind("keydown","return",function(){$jb(".note.current textarea").focus();
return!1});$jb(document).bind("keydown","tab",function(){$jb(".note.current textarea").focus();return!1});$jb(document).bind("keydown","shift+/",function(){$jb(".settings").toggleClass("show")});$jb(document).bind("keydown","/",function(){$jb(".search input").select();return!1});$jb(document).bind("keydown","c",function(){createNote();return!1});$jb(document).bind("keydown","s",function(){simplenoteSync();return!1});$jb(document).bind("keydown","p",function(){togglePin($jb(".selected"))});$jb(".search input").bind("keydown",
"return",function(){$jb(this).blur();return!1});$jb(".search input").bind("keydown","esc",function(){$jb(this).val("");$jb(this).blur();return!1});refreshNoteBinds(".note textarea")});function refreshNoteBinds(a){$jb(a).bind("keydown","esc",function(){$jb(".note-directions").removeClass("show");$jb(this).blur()});$jb(a).bind("keydown","tab",function(){return!1})}$jb(function(){mapMousewheel()});
function mapMousewheel(){$jb(".window").mousewheel(function(a,b){b<0?nextNote():b>0&&prevNote();return!1})}$jb(function(){bindTimeago()});function bindTimeago(){console.log("timeago found "+$jb(".timeago").length+" items");$jb(".timeago").timeago()}$jb(".note textarea").live("focus",function(){$jb(".current .note-directions").addClass("show");$jb("div.current").addClass("highlight");$jb(".window").unmousewheel()});
$jb(".note textarea").live("blur",function(){blurkey=$jb(this).parent().parent().attr("id");if($jb(this).val()!=$jb("#list-"+blurkey).data().content)blurnote=$jb.parseJSON(localStorage.getItem(blurkey)),blurnote.content=$jb(this).val(),blurnote.modifydate=(new Date).getTime()/1E3,blurnote.syncnum+=1,localStorage.setItem(blurkey,JSON.stringify(blurnote)),localToDOM(blurnote.key);$jb(".current .note-directions").removeClass("show");$jb(".current").removeClass("highlight");mapMousewheel()});
function togglePin(a){a.data().systemtags.indexOf("pinned")>-1?a.data().systemtags.splice(a.data().systemtags.indexOf("pinned"),1):a.data().systemtags.push("pinned");a.data().syncnum=a.data().syncnum+1;localStorage.setItem(a.data().key,JSON.stringify(a.data()));localToDOM(a.data().key);sortNotes();refreshCards()}
function createNote(){newid="99";$jb(".current").removeClass("current");$jb(".note:first").clone().attr("id","window-"+newid).insertAfter(".toolbar").addClass("current");$jb(".note:first textarea").val("new note");reflowCards();$jb('<div class="listnote"></div>').attr("id","list-"+newid).prependTo(".list");$jb('<div class="title"></div><div class="preview"></div>').appendTo(".listnote:first");$jb(".selected").removeClass("selected");$jb(".listnote:first").addClass("selected");updateListnote(newid);
$jb(".current textarea").select();refreshNoteBinds(".current textarea")}function nextNote(){$jb(".selected").next(".listnote").length>0&&($jb(".selected").removeClass("selected").next(".listnote").addClass("selected"),$jb(".current").removeClass("current").next(".note").addClass("current"),reflowCards(),scrollto())}
function prevNote(){$jb(".selected").prev(".listnote").length>0&&($jb(".selected").removeClass("selected").prev(".listnote").addClass("selected"),$jb(".current").removeClass("current").prev(".note").addClass("current"),reflowCards(),scrollto())}function scrollto(){}
jQuery.fn.sortElements=function(){var a=[].sort;return function(b,c){var c=c||function(){return this},f=this.map(function(){var a=c.call(this),b=a.parentNode,d=b.insertBefore(document.createTextNode(""),a.nextSibling);return function(){if(b===this)throw Error("You can't sort elements if any one is a descendant of another.");b.insertBefore(this,d);b.removeChild(d)}});return a.call(this,b).each(function(a){f[a].call(c.call(this))})}}();
function stackTime(a){offset_dt=(new Date).getTimezoneOffset()*60;epoch_num=parseFloat(a);time_num=(epoch_num+offset_dt)*1E3;return time_dt=(new Date(epoch_num*1E3)).toISOString()}function padzero(a){return a<10?"0"+a:a}function pad2zeros(a){a<100&&(a="0"+a);a<10&&(a="0"+a);return a}
function toISOString(a){return a.getUTCFullYear()+"-"+padzero(a.getUTCMonth()+1)+"-"+padzero(a.getUTCDate())+"T"+padzero(a.getUTCHours())+":"+padzero(a.getUTCMinutes())+":"+padzero(a.getUTCSeconds())+"."+pad2zeros(a.getUTCMilliseconds())+"Z"}function fnToISO(){alert(toISOString(new Date))};